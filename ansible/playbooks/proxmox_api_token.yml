---
# This playbook ensures that:
# - automation user exists in Proxmox
# - correct ACL is assigned
# - one or more API tokens exist
# - all secrets are stored in SOPS per-cluster file

- name: Ensure Proxmox API user, ACLs and tokens
  hosts: router-pve
  become: true
  gather_facts: false

  # The cluster name MUST be defined here or via -e proxmox_cluster_name=...
  vars:
    proxmox_cluster_name: "router-pve"

  pre_tasks:
    - name: Load SOPS secrets for this PVE node (root password)
      community.sops.load_vars:
        file: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/secrets.sops.yml"
        name: pve_secrets
        config_path: "{{ inventory_dir | dirname }}/.sops.yaml"
      delegate_to: localhost
      run_once: true
      no_log: true

    - name: Set admin password for Proxmox API from host secrets
      ansible.builtin.set_fact:
        proxmox_api_admin_password: "{{ pve_secrets.root_password }}"
      run_once: true
      no_log: true

  roles:
    - proxmox_api_token
